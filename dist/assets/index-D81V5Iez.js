var U=Object.defineProperty;var C=(o,t,e)=>t in o?U(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var f=(o,t,e)=>(C(o,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const r of n.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function e(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=e(s);fetch(s.href,n)}})();const u=Object.freeze({FOLLOWER:0,LEADER:1,CANDIATE:2,DELETED:3}),a=Object.freeze({HEARTBEAT:0,REQUEST_VOTE:1,CAST_VOTE:2,NEW_NODE:3,LOG_REQUEST:4,LOG_RESPONSE:5,DELETE_NODE:6});class H{constructor(t,e,i,s,n,r,h,d=u.FOLLOWER,c=0){this.nodeId=t,this.nodes=e||[],this.minElectionTimeout=i,this.maxElectionTimeout=s,this.heartbeat=n,this.state=d,this.term=c,this.logs=[],this.db=[],this.onElectionTimeoutUpdate=h,this.electionInterval=this.startElectionInterval(),this.votedFor=null,this.votesReceived=new Set,this.broadcastFn=r||(()=>null),this.sentLength=new Map,this.ackedLength=new Map,this.commitLength=0}delete(){this.nodeId=void 0,this.nodes=[],this.minElectionTimeout=void 0,this.maxElectionTimeout=void 0,this.heartbeat=void 0,this.state=u.DELETED,this.term=void 0,this.logs=[],this.db=[],clearInterval(this.electionInterval),this.votedFor=void 0,this.votesReceived=void 0,this.broadcastFn=void 0,this.sentLength=void 0,this.ackedLength=void 0,this.commitLength=void 0}appendLog(t,e,i){if(console.log({prefixLen:t,leaderCommit:e,suffix:i}),i.length>0&&this.logs.length>t){const s=Math.min(this.logs.length,t+i.length)-1;this.logs[s].term!=i[s-t].term&&(this.logs=this.logs.slice(0,t))}if(t+i.length>this.logs.length)for(let s=this.logs.length-t;s<i.length;s++)this.logs.push(i[s]);e>this.commitLength&&this.commit(this.commitLength,e)}commit(t,e){console.log("committing at node ",this.nodeId);const i=this.logs.slice(t,e).map(s=>s.msg);this.db=this.db.concat(i),this.commitLength=e}startElectionInterval(){return this.electionTimeout=this.getNewElectionTimeout(),this.onElectionTimeoutUpdate(this.nodeId),setInterval(()=>this.timedOut(),this.electionTimeout)}resetElectionInterval(){clearInterval(this.electionInterval),this.electionInterval=this.startElectionInterval()}getNewElectionTimeout(){return Math.floor(Math.random()*(this.maxElectionTimeout-this.minElectionTimeout)+this.minElectionTimeout)}timedOut(){console.log("Election timout complete at node: ",this.nodeId,"after timeout ",this.electionTimeout),this.state!==u.LEADER&&(this.state=u.CANDIATE,this.term+=1,this.votedFor=this.nodeId,this.votesReceived=new Set([this.nodeId]),this.broadcastFn(this.nodeId,{type:a.REQUEST_VOTE,nodeId:this.nodeId,voteTerm:this.term,logLength:this.logs.length,logLastTerm:this.getLastTermFromLog()},-1))}getLastTermFromLog(){return this.logs.length>0?this.logs[this.logs.length-1].term:0}createKey(t,e){return[t,e].join("_")}getTerm(t){return t&&t.split("_")[0]}startHeartbeatBroadcast(){this.broadcastFn(this.nodeId,{type:a.HEARTBEAT,data:this.createHeartbeatData()},-1),this.heartbeatInterval=setInterval(()=>{this.resetElectionInterval(),this.broadcastFn(this.nodeId,{type:a.HEARTBEAT,data:this.createHeartbeatData()},-1)},this.heartbeat)}setLeader(){this.state=u.LEADER,this.startHeartbeatBroadcast(),this.nodes.forEach(t=>{t!=this.nodeId&&(this.sentLength.set(t,this.logs.length),this.ackedLength.set(t,0),this.replicateLog(t))})}setFollower(){this.state=u.FOLLOWER,this.heartbeatInterval&&clearInterval(this.heartbeatInterval)}onMessageReceived(t){var i;const e=t.data;switch(e.type){case a.HEARTBEAT:{this.resetElectionInterval(),this.handleLogRequest(e.data[this.nodeId]);return}case a.REQUEST_VOTE:{this.handleVoteRequest(e);return}case a.CAST_VOTE:{this.handleCastedVote(e);return}case a.NEW_NODE:{this.nodes.push(e.nodeId),this.ackedLength.set(e.nodeId,0),this.state==u.LEADER&&this.replicateLog(e.nodeId);return}case a.DELETE_NODE:{const s=e.nodeId;this.nodes=this.nodes.filter(n=>n!=s),(i=this.ackedLength)==null||i.delete(s);return}case a.LOG_REQUEST:return console.log("LOG_REQUEST",{msg:e}),this.handleLogRequest(e);case a.LOG_RESPONSE:return console.log("LOG_RESPONSE",{msg:e}),this.handleLogResponse(e);default:console.log("Unknown message type received at receiver channel !")}}getQuorum(){return Math.ceil((this.nodes.length+1)/2)}handleVoteRequest(t){const e=t.nodeId,i=t.voteTerm,s=t.logLength,n=t.logLastTerm;i>this.term&&(this.term=i,this.setFollower(),this.votedFor=null);const r=this.getLastTermFromLog(),h=n>r||n===r&&s>=this.logs.length;i===this.term&&h&&(this.votedFor===e||this.votedFor===null)?(this.votedFor=e,this.broadcastFn(this.nodeId,{type:a.CAST_VOTE,nodeId:this.nodeId,term:this.term,vote:!0},e)):this.broadcastFn(this.nodeId,{type:a.CAST_VOTE,nodeId:this.nodeId,term:this.term,vote:!1},e),this.resetElectionInterval()}handleCastedVote(t){const e=t.nodeId,i=t.term,s=t.vote;this.state===u.CANDIATE&&i===this.term&&s?(this.votesReceived.add(e),this.votesReceived.size>=this.getQuorum()&&this.setLeader()):i>this.term&&(this.term=i,this.setFollower(),this.votedFor=null,this.votesReceived=new Set),this.resetElectionInterval()}createLogRequest(t,e){const i=this.nodeId,s=this.sentLength.get(e)||0,n=this.logs.slice(s);let r=0;return s>0&&(r=this.logs[s-1].term),{type:t,leaderId:i,currentTerm:this.term,prefixLen:s,prefixTerm:r,commitLength:this.commitLength,suffix:n}}createHeartbeatData(){let t={};for(const e of this.nodes)t[e]=this.createLogRequest(a.HEARTBEAT,e);return t}replicateLog(t){this.broadcastFn(this.nodeId,this.createLogRequest(a.LOG_REQUEST,t),t)}handleLogRequest(t){const{type:e,leaderId:i,currentTerm:s,prefixLen:n,prefixTerm:r,commitLength:h,suffix:d}=t;s>this.term&&(this.term=s,this.votedFor=null,this.votesReceived=new Set,this.resetElectionInterval()),s==this.term&&this.setFollower();const c=this.logs.length>=n&&(n==0||this.logs[n-1].term==r);if(s==this.term&&c){this.appendLog(n,h,d);const m=n+d.length;if(e===a.HEARTBEAT){this.commitLength<h&&this.commit(this.commitLength,h);return}this.broadcastFn(this.nodeId,{type:a.LOG_RESPONSE,nodeId:this.nodeId,currentTerm:this.term,ack:m,success:!0},i)}else this.broadcastFn(this.nodeId,{type:a.LOG_RESPONSE,nodeId:this.nodeId,currentTerm:this.term,ack:0,success:!1},i)}handleLogResponse(t){const{nodeId:e,currentTerm:i,ack:s,success:n}=t;i==this.term&&this.state==u.LEADER?n==!0&&s>=this.ackedLength.get(e)?(this.sentLength.set(e,s),this.ackedLength.set(e,s),this.leaderCommit()):this.sentLength[e]>0&&(this.sentLength.set(e,this.sentLength.get(e)-1),this.replicateLog(e)):i>this.term&&(this.term=i,this.setFollower(),this.votedFor=null,this.votesReceived=new Set,this.resetElectionInterval())}leaderCommit(){const t=this.getQuorum(),e=this.logs.map((s,n)=>this.nodes.filter(h=>this.ackedLength.get(h)>=n+1).length>=t?n+1:-1),i=Math.max(...e);e.length!=0&&i>this.commitLength&&this.logs[i-1].term==this.term&&this.commit(this.commitLength,i)}receiveData(t){this.state==u.LEADER&&(this.logs.push({term:this.term,msg:t}),this.ackedLength.set(this.nodeId,this.logs.length),this.nodes.forEach(e=>{e!=this.nodeId&&this.replicateLog(e)}))}}class q{constructor(t,e,i,s,n){this.minElectionTimeout=t,this.maxElectionTimeout=e,this.heartbeat=i,this.broadcastFn=s,this.onElectionTimeoutUpdate=n}createNode(t,e){return new H(t,e,this.minElectionTimeout,this.maxElectionTimeout,this.heartbeat,this.broadcastFn,this.onElectionTimeoutUpdate)}}const v=470,p=470,g=200,M="#e3dada";function R(o,t,e,i,s,n,r="20px"){o.beginPath(),o.arc(t,e,i,0,2*Math.PI,!1),s&&(o.fillStyle=s,o.fill()),o.lineWidth=2,o.strokeStyle="gray",o.stroke(),n&&(o.font=`${r} Georgia`,o.fillStyle="black",o.textAlign="center",o.fillText(n,t,e+3))}function P(o,t,e,i){var s=e-o,n=i-t;return{distance:Math.sqrt(s*s+n*n),angle:Math.atan2(n,s)*180/Math.PI}}function V(o,t){var e=t*Math.PI/180;const i=o*Math.cos(e),s=o*Math.sin(e);return{x:i,y:s}}function z(o){const t=[];for(let e=0;e<o;e++){const i=e/(o/2)*Math.PI,s=g*Math.cos(i)+(g*2+50)/2,n=g*Math.sin(i)+(g*2+50)/2;t.push({x:s,y:n})}return t}function D(o,t){const e=o.length;for(let i=0;i<t;i++){const s=i/(t/2)*Math.PI,n=g*Math.cos(s)+(g*2+50)/2,r=g*Math.sin(s)+(g*2+50)/2;i<e?(o[i].x=n,o[i].y=r):o.push({x:n,y:r})}t<o.length&&o.splice(t)}function y(o,t,e){let i=0,s=0,n=e.electionTimeout/1e3,r=t.x,h=t.y;function d(c){if(o.clearRect(r-30,h-30,70,70),e.nodeId==null)return;const{x:m,y:E}=t,I=(i?c-i:0)/1e3;if(s+=I/n*2*Math.PI,i=c,r=m,h=E,o.beginPath(),o.arc(m,E,25,0,s),o.stroke(),R(o,m,E,15,M,e.nodeId),s>2*Math.PI){o.clearRect(m-30,E-30,70,70),R(o,m,E,15,M);return}(async()=>{for(;window.isPaused;)await new Promise(w=>{setTimeout(()=>{w()},1e3)}),i+=1e3;window.requestAnimationFrame(d)})()}window.requestAnimationFrame(d)}function G(o,t){const{x:e,y:i}=t;o.clearRect(e-30,i-30,70,70)}function W(o,t,e,i){for(let s=0;s<e.length;s++)y(t,e[s],i[s])}function Q(o){switch(o){case a.HEARTBEAT:return{color:"#f8b1bb",size:5,text:"H",textSize:"10px"};case a.LOG_REQUEST:return{color:"#a3cff5",size:10,text:"L",textSize:"12px"};case a.REQUEST_VOTE:return{color:"#e6e5b1",size:10,text:"R",textSize:"12px"};default:return{color:void 0,size:10}}}async function _(o,t,e,i,s,n){const r=o.network.getContext("2d");let h=0,d=t.x,c=t.y;const m=e.x,E=e.y;if(t.x==e.x&&t.y==e.y)return;const T=Q(n),I=P(t.x,t.y,e.x,e.y),A=i/1e3,w=I.distance/A,b=V(w,I.angle);return new Promise((B,Y)=>{function N(F){r.clearRect(d-15,c-15,30,30);const S=(h?F-h:0)/1e3;d+=b.x*S,c+=b.y*S,h=F,R(r,d,c,T.size,T.color,T.text,T.textSize);const x=P(d,c,m,E);if(Math.abs(Math.floor(I.angle)-Math.floor(x.angle))>2){r.clearRect(d-15,c-15,30,30),B();return}(async()=>{for(;window.isPaused;)await new Promise(k=>{setTimeout(()=>{k()},1e3)}),h+=1e3;window.requestAnimationFrame(N)})()}window.requestAnimationFrame(N)})}const l=class l{constructor(t){f(this,"broadcastFn",async(t,e,i)=>{if(t===-1){this.senderBcs.forEach(async s=>{s.postMessage(e)});return}i===-1?this.senderBcs.forEach(async(s,n)=>{t-1!==n&&(e.type===a.HEARTBEAT&&(this.leader=t),await _(this.canvas,this.nodePositions[t-1],this.nodePositions[n],l.NETWORK_DELAY,this.nodePositions,e.type),s.postMessage(e))}):(await _(this.canvas,this.nodePositions[t-1],this.nodePositions[i-1],l.NETWORK_DELAY,this.nodePositions,e.type),this.senderBcs[i-1].postMessage(e))});f(this,"onElectionTimeoutUpdate",t=>{var i,s;const e=(s=(i=this.canvas)==null?void 0:i.nodes)==null?void 0:s.getContext("2d");t>this.nodes.length||e&&y(e,this.nodePositions[t-1],this.nodes[t-1])});this.numOfNodes=t;let e=1;for(this.nodes=[],this.senderBcs=[],this.receiverBcs=[],this.nextNodeId=t+1,this.nodeFactory=new q(l.MIN_ELECTION_TIMEOUT,l.MAX_ELECTION_TIMEOUT,l.HEARTBEAT,this.broadcastFn,this.onElectionTimeoutUpdate),this.nodeIds=Array.from({length:t},(i,s)=>s+1);e<=t;)this.nodes.push(this.createNode(e)),e++;this.leader=void 0,this.canvas={network:document.getElementById("network"),nodes:document.getElementById("nodes")},this.nodePositions=z(this.nodes.length),this.renderCanvas()}renderCanvas(){const t=this.canvas.nodes.getContext("2d");W(this.canvas,t,this.nodePositions,this.nodes)}setLeader(t){this.leader&&this.nodes[this.leader].setFollower(),this.leader=t,this.nodes[t].setLeader()}resetLeader(){this.nodes.forEach(t=>{t.setFollower()})}createNode(t){const e=this.nodeFactory.createNode(t,this.nodeIds.slice()),i=new BroadcastChannel(t),s=new BroadcastChannel(t);return this.senderBcs.push(i),s.onmessage=n=>{e.onMessageReceived(n)},e}addNode(){var i,s;const t=(s=(i=this.canvas)==null?void 0:i.nodes)==null?void 0:s.getContext("2d"),e=this.nextNodeId++;this.nodeIds.push(e),this.nodes.push(this.createNode(e)),D(this.nodePositions,this.nodes.length),y(t,this.nodePositions[this.nodes.length-1],this.nodes[this.nodes.length-1]),this.broadcastFn(-1,{type:a.NEW_NODE,nodeId:e},-1)}removeLastNode(){const t=this.nextNodeId-1;this.nextNodeId=this.nextNodeId-1,this.removeNode(t)}removeNode(t){var i,s;const e=(s=(i=this.canvas)==null?void 0:i.nodes)==null?void 0:s.getContext("2d");G(e,this.nodePositions[t-1]),this.nodes[t-1].delete(),this.nodeIds=this.nodeIds.filter(n=>n!=t),this.nodes=this.nodes.filter((n,r)=>r!=t-1),this.senderBcs[t-1].close(),this.senderBcs=this.senderBcs.filter((n,r)=>r!=t-1),D(this.nodePositions,this.nodes.length),this.broadcastFn(-1,{type:a.DELETE_NODE,nodeId:t},-1)}};f(l,"HEARTBEAT",5e3),f(l,"MAX_ELECTION_TIMEOUT",9e3),f(l,"MIN_ELECTION_TIMEOUT",6e3),f(l,"NETWORK_DELAY",1500);let O=l;window.isPaused=!1;window.setInterval=(o,t)=>{let e=!0,i,s=()=>null,n;return(async()=>{for(;e;){for(i=t;i>0;){if(window.isPaused){await new Promise(h=>{setTimeout(()=>{h()},1e3)});continue}await new Promise(h=>{n=h,s=setTimeout(()=>{h()},200)}),i=i-200}e&&o()}})(),()=>{clearTimeout(s),n(),e=!1}};window.clearInterval=o=>{o()};document.querySelector("#app").innerHTML=`
  <div class="main">
    <h1>Raft</h1>
    <div id='board' style="height: ${v}px; width: ${p}px;">
      <canvas id='network'
        width=${p}
        height=${v}
        style="width: ${p}px; height:${v}px;box-sizing:border-box"
      ></canvas>
      <canvas id='nodes' width=${p} height=${v} /></canvas>
    </div>
    <button id="resetLeader">Reset Leader</button>
    <button id="addNode">Add Node</button>
    <button id="removeNode">Remove Node</button>
    <button id="addData">Send Data</button>
    <button id="pause">Play / Pause</button>
  </div>
`;const $=5;console.log("Initializing network...");const L=new O($);L.setLeader(0);document.getElementById("resetLeader").addEventListener("click",()=>{console.log("RESET LEADER TO FOLLOWER"),L.resetLeader()});document.getElementById("addNode").addEventListener("click",()=>{L.addNode()});document.getElementById("removeNode").addEventListener("click",()=>{L.removeLastNode()});let K=1;document.getElementById("addData").addEventListener("click",()=>{if(!L.leader){console.log("NO LEADER DEFINED");return}L.nodes[L.leader-1].receiveData(K++)});document.getElementById("pause").addEventListener("click",()=>{window.isPaused?window.isPaused=!1:window.isPaused=!0});
